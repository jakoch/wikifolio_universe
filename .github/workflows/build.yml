#
# .github/workflows/build-on-windows.yml
#
# Copyright 2021 Jens A. Koch.
# SPDX-License-Identifier: BSL-1.0
# This file is part of https://github.com/jakoch/wikifolio_universe.
#

name: "Build"

on:
  schedule:
    # Daily at 08:00.
    - cron: '0 8 * * *'
  push:
  pull_request:

jobs:

# ---------------------------------------------------------------------------------------

  build:

# ---------------------------------------------------------------------------------------

    name: "Build"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main branch
      uses: actions/checkout@v2

    - name: Checkout gp-pages branch into data folder
      uses: actions/checkout@v2
      with:
        ref: gh-pages
        path: data
        fetch-depth: 1

    - name: âœ— Cleanup data folder before generating new content
      run: |
        cd data
        rm -rf README.md wiuc sqlite/*.sqlite.zip csv/*.csv.zip
        ls

    - name: ðŸ”½ Install
      run: |
        chmod +x ./convert.sh
        . ./convert.sh && run
        
    - name: âœ— Pre-Commit Cleanup
      run: |
        cd data
        rm -rf wiuc
        ls

    # Re-initialize the cleaned repo and commit it.
    # git init
    - name: âœ” Commit
      run: |
        cd data
        git add -A
        git config --local user.email "github-actions[bot]@users.noreply.jakoch.wikifolio_universe.org"
        git config --local user.name "github-actions[bot]"
        git commit -m "Publish docs from ${GITHUB_REPOSITORY}@${GITHUB_SHA:0:9}"

    # Push the repo to the gh-pages branch.
    - name: ðŸš€ Push
      uses: ad-m/github-push-action@v0.6.0 # https://github.com/ad-m/github-push-action
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        directory: data
        branch: gh-pages
        force: true
