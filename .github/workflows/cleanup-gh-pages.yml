name: Cleanup gh-pages

on:
  workflow_dispatch:

permissions:
  contents: write # required to push to the repository

jobs:
  clean-gh-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages only
        uses: actions/checkout@v5 # https://github.com/actions/checkout
        with:
          ref: gh-pages
          fetch-depth: 0  # full history for git filter-repo

      - name: Install git-filter-repo
        run: |
          sudo apt-get update
          sudo apt-get install -y git-filter-repo

      - name: Remove all commits before the first day of current month
        run: |
          # Generate "YYYY-MM-01" for the current month
          CUTOFF_DATE=$(date +%Y-%m-01)
          echo "Cutoff date: $CUTOFF_DATE"

          # Get the first commit for the first day of this month
          FIRST_COMMIT=$(git log --reverse --since="$CUTOFF_DATE" --format="%H" | head -n 1)
          echo "First commit for $CUTOFF_DATE: $FIRST_COMMIT"

          # Keep only the history from that commit onward
          git filter-repo --force --keep-branches --keep-tags --keep="$FIRST_COMMIT..gh-pages"

      - name: Cleanup Git History
        run: |
          git reflog expire --all --expire=now
          git gc --prune=now --aggressive

      - name: Force Push Cleaned Branch
        run: |
          git push --force origin gh-pages
