name: Cleanup gh-pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 2 * *'  # Run on 2nd day of each month at 3 AM UTC

permissions:
  contents: write

jobs:
  clean-gh-pages-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages (shallow)
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          fetch-depth: 32 # needed for --deepen in later steps

      - name: Set git user identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

        # FETCH_SINCE         = first day of the previous month (ensures last month is complete).
        # CURRENT_MONTH_START = first day of current month (upper bound).
        # FETCH_UNTIL         = last second of previous month.
      - name: Set monthly cutoff dates
        id: dates
        run: |
            # First day of previous month (since "yesterday" ensures we never use current incomplete month)
            FETCH_SINCE="$(date -u -d 'yesterday' '+%Y-%m-01') 00:00:00"

            # First day of current month (for reference)
            CURRENT_MONTH_START="$(date -u '+%Y-%m-01') 00:00:00"

            # Last second of previous month
            FETCH_UNTIL="$CURRENT_MONTH_START"

            echo "fetch_since=$FETCH_SINCE" >> "$GITHUB_OUTPUT"
            echo "fetch_until=$FETCH_UNTIL" >> "$GITHUB_OUTPUT"
            echo "target_month=${FETCH_SINCE:0:7}" >> "$GITHUB_OUTPUT"  # e.g. "2025-10"

            echo "‚úÖ Processing month: ${FETCH_SINCE:0:7}"
            echo "   Since: $FETCH_SINCE"
            echo "   Until: $FETCH_UNTIL"

      - name: Find first commit of current month
        id: find_commit
        run: |
          set -euo pipefail

          SINCE="${{ steps.dates.outputs.fetch_since }}"
          UNTIL="${{ steps.dates.outputs.fetch_until }}"

          DEPTH=10
          MAX_DEPTH=60
          FIRST_COMMIT=""

          # Loop: fetch incrementally and scan commits
          while [ -z "${FIRST_COMMIT:-}" ] && [ "$DEPTH" -le "$MAX_DEPTH" ]; do
            echo "üîç Fetching next $DEPTH commits..."
            git fetch --deepen=$DEPTH origin gh-pages

            # Get the very first commit in the target month (oldest ‚Üí newest)
            FIRST_COMMIT=$(git log origin/gh-pages --since="$SINCE" --until="$UNTIL" --reverse --format="%H" | head -n1)

            if [ -n "$FIRST_COMMIT" ]; then
                break
            fi

            DEPTH=$((DEPTH + 10))
          done

          # Exit if no commit found
          if [ -z "${FIRST_COMMIT:-}" ]; then
            echo "‚ö†Ô∏è No commits found in target month (${{ steps.dates.outputs.target_month }}) ‚Äî skipping."
            exit 0
          fi

          echo "‚úÖ First commit of ${{ steps.dates.outputs.target_month }}: $FIRST_COMMIT"
          echo "first_commit=$FIRST_COMMIT" >> "$GITHUB_OUTPUT"

      - name: Create gh-pages-review branch with full monthly history
        run: |
          set -euo pipefail
          FIRST_COMMIT="${{ steps.find_commit.outputs.first_commit }}"
          SINCE="${{ steps.dates.outputs.fetch_since }}"
          UNTIL="${{ steps.dates.outputs.fetch_until }}"
          TARGET_MONTH="${{ steps.dates.outputs.target_month }}"

          # Get ALL commits in the target month, in chronological order
          COMMITS=$(git log origin/gh-pages --since="$SINCE" --until="$UNTIL" --reverse --format="%H")
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)

          if [ -z "$FIRST_COMMIT" ] || [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è No commits found for $TARGET_MONTH"
           exit 0
          fi

          echo "üì¶ Found $COMMIT_COUNT commits for $TARGET_MONTH"

          # Create branch starting at the FIRST commit (not orphan!)
          git checkout -b gh-pages-review "$FIRST_COMMIT"

          # Get the rest of the commits (skip the first)
          REST_COMMITS=$(echo "$COMMITS" | tail -n +2)

          # Cherry-pick the rest
          if [ -n "$REST_COMMITS" ]; then
            echo "$REST_COMMITS" | xargs git cherry-pick
          fi

          echo "‚úÖ gh-pages-review now contains full history of $TARGET_MONTH"
          echo "   Total commits: $(git rev-list --count HEAD)"

      - name: Push gh-pages-review branch
        run: |
          git push origin gh-pages-review --force

      #- name: Cleanup local branch
      #  run: |
      #    git checkout gh-pages
      #    git branch -D gh-pages-review || true
