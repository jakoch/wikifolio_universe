name: Cleanup gh-pages (review, shallow safe)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 2 * *'  # Run on 2nd day of each month at 3 AM UTC

permissions:
  contents: write

jobs:
  clean-gh-pages-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages (shallow clone)
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          fetch-depth: 10  # start small, we'll deepen as needed

      - name: Set git user identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find first commit of current month (deepening as needed)
        id: find_commit
        run: |
          set -euo pipefail

          TARGET_MONTH_START=$(date '+%Y-%m-01 00:00:00')
          echo "Looking for first commit since: $TARGET_MONTH_START"

          FIRST_COMMIT=""
          DEPTH=10
          MAX_DEPTH=90  # prevent infinite loop

          while [ -z "$FIRST_COMMIT" ] && [ $DEPTH -le $MAX_DEPTH ]; do
            echo "ðŸ”Ž Searching with depth=$DEPTH..."
            git fetch --deepen=$DEPTH origin gh-pages

            FIRST_COMMIT=$(git log \
              --since="$TARGET_MONTH_START" \
              --reverse --pretty=format:"%H" --no-merges | head -n 1 || true)

            if [ -z "$FIRST_COMMIT" ]; then
              echo "No commit found yet â€” deepening..."
              DEPTH=$((DEPTH * 2))
            fi
          done

          if [ -z "$FIRST_COMMIT" ]; then
            echo "âŒ Could not find first commit of month (history too shallow)."
            exit 0
          fi

          echo "âœ… Found first commit of this month: $FIRST_COMMIT"
          echo "first_commit=$FIRST_COMMIT" >> $GITHUB_OUTPUT

      - name: Create gh-pages-review branch from cutoff
        run: |
          set -euo pipefail
          git checkout -b gh-pages-review
          git reset --hard ${{ steps.find_commit.outputs.first_commit }}
          echo "âœ… gh-pages-review now starts from ${{ steps.find_commit.outputs.first_commit }}"

      - name: Push gh-pages-review branch
        run: |
          git push origin gh-pages-review --force

      - name: Show summary
        run: |
          echo "âœ… gh-pages-review branch pushed."
          echo "Contains all commits from $(date '+%Y-%m-01') onward."
