name: Cleanup gh-pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 2 * *'  # Run on 2nd day of each month at 3 AM UTC

permissions:
  contents: write

jobs:
  clean-gh-pages-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages (shallow)
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          fetch-depth: 1  # fetch latest commit, then use fetch shallow-since later

      - name: Set git user identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find first commit of current month
        id: find_commit
        run: |
          set -euo pipefail

          # Fetch all commits since the first day of this month
          git fetch --shallow-since=$(date '+%Y-%m-01') origin gh-pages

          FIRST_COMMIT=$(git rev-list --reverse --since="$(date '+%Y-%m-01 00:00:00')" --max-count=1 gh-pages || true)

          # handle empty month case
          if [ -z "${FIRST_COMMIT:-}" ]; then
            echo "No commits found for this month — skipping workflow."
            exit 0
          fi

          echo "✅ First commit of this month: $FIRST_COMMIT"
          echo "first_commit=$FIRST_COMMIT" >> $GITHUB_OUTPUT

      - name: Create gh-pages-review branch with only monthly commits
        run: |
          set -euo pipefail

          # Find first commit of current month
          FIRST=$(git rev-list --reverse --since="$(date '+%Y-%m-01 00:00:00')" gh-pages | head -n 1)

          # Find all commits from this month (excluding the first one)
          MONTH_COMMITS=$(git rev-list --reverse --since="$(date '+%Y-%m-01 00:00:00')" gh-pages | grep -v "^$FIRST$")

          # Start a truly orphan branch
          git checkout --orphan gh-pages-review
          git reset --hard  # start empty

          # Recreate first commit as new root
          git checkout $FIRST -- .
          git commit -m "$(git log -1 --pretty=%B $FIRST)" --date="$(git show -s --format=%ci $FIRST)"

          # Cherry-pick the rest of the month
          if [ -n "$MONTH_COMMITS" ]; then
            git cherry-pick $MONTH_COMMITS || true
          fi

          echo "✅ gh-pages-review branch now contains all commits from $FIRST onward."

      - name: Push gh-pages-review branch
        run: |
          git push origin gh-pages-review --force

      - name: Show summary
        run: |
          echo "✅ gh-pages-review pushed."
          echo "Contains only commits from $(date '+%Y-%m-01') onward."
