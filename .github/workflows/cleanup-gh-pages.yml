name: Cleanup gh-pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 2 * *'  # Run on 2nd day of each month at 3 AM UTC

permissions:
  contents: write

jobs:
  clean-gh-pages-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages (shallow)
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          fetch-depth: 1

      - name: Set git user identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set fetch cutoff and month start date
        id: dates
        run: |
          FETCH_SINCE="$(date -u -d 'yesterday' '+%Y-%m-01') 00:00:00"
          MONTH_START="$(date -u '+%Y-%m-01') 00:00:00"
          echo "fetch_since=$FETCH_SINCE" >> $GITHUB_OUTPUT
          echo "month_start=$MONTH_START" >> $GITHUB_OUTPUT
          echo "✅ FETCH_SINCE=$FETCH_SINCE, MONTH_START=$MONTH_START"

      - name: Find first commit of current month
        id: find_commit
        run: |
          set -euo pipefail

          git fetch --shallow-since="${{ steps.dates.outputs.fetch_since }}" --unshallow origin gh-pages

          FIRST_COMMIT=$(git rev-list --reverse --since="${{ steps.dates.outputs.month_start }}" --max-count=1 gh-pages)

          if [ -z "${FIRST_COMMIT:-}" ]; then
            echo "No commits found for this month — skipping workflow."
            exit 0
          fi

          echo "✅ First commit of this month: $FIRST_COMMIT"
          echo "first_commit=$FIRST_COMMIT" >> $GITHUB_OUTPUT

      - name: Create gh-pages-review branch with monthly commits
        run: |
          set -euo pipefail
          FIRST_COMMIT=${{ steps.find_commit.outputs.first_commit }}
          MONTH_START=${{ steps.dates.outputs.month_start }}

          # Find all commits from this month excluding first
          MONTH_COMMITS=$(git rev-list --reverse --since="$MONTH_START" --skip=1 gh-pages || true)

          # Start orphan branch
          git checkout --orphan gh-pages-review
          git reset --hard

          # Recreate first commit
          git checkout $FIRST_COMMIT -- .
          git commit -m "$(git log -1 --pretty=%B $FIRST_COMMIT)" --date="$(git show -s --format=%ci $FIRST_COMMIT)"

          # Cherry-pick the rest of the month
          if [ -n "$MONTH_COMMITS" ]; then
            git cherry-pick $MONTH_COMMITS || { echo "❌ Cherry-pick failed"; exit 1; }
          fi

          echo "✅ gh-pages-review branch now contains all commits from $FIRST_COMMIT onward."
          echo "Included $(git rev-list --count HEAD) commits in gh-pages-review."

      - name: Push gh-pages-review branch
        run: |
          git push origin gh-pages-review --force

      #- name: Cleanup local branch
      #  run: |
      #    git checkout gh-pages
      #    git branch -D gh-pages-review || true
